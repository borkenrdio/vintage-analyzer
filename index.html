<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>古着店 売上分析ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 35vh;
            width: 100%;
        }
        .nav-link.active {
            background-color: #4f46e5;
            color: white;
        }
        .tab-link.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .no-data-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6b7280;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- ヘッダーとナビゲーション -->
    <header class="bg-white shadow-md sticky top-0 z-20">
        <div class="container mx-auto px-4">
            <nav class="flex items-center justify-between h-16">
                <div id="display-store-name" class="text-xl font-bold text-indigo-600">VINTAGE ANALYZER</div>
                <div class="flex space-x-2">
                    <a href="#" id="nav-home" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-200">Home</a>
                    <a href="#" id="nav-analytic" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-200">Analytic</a>
                    <a href="#" id="nav-import" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-200">Import</a>
                    <a href="#" id="nav-setting" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-200">Setting</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <!-- Home ページ -->
        <div id="home-page" class="page">
            <div class="bg-white p-8 rounded-lg shadow-md text-center">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">ようこそ！</h1>
                <p class="text-lg text-gray-600 mb-6">このダッシュボードは、古着店の売上データを分析するためのツールです。<br>「Import」ページからCSVファイルをアップロードして、分析を始めましょう。</p>
                <button id="go-to-import-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    データをインポートする
                </button>
            </div>
        </div>

        <!-- Import ページ -->
        <div id="import-page" class="page hidden">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- 売上データアップロード -->
                <div id="sales-upload-container">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">売上データ</h2>
                    <div id="sales-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer bg-white hover:bg-gray-50 transition-colors">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="w-12 h-12 text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 21H5.25A2.25 2.25 0 013 17.25z" /></svg>
                            <p class="text-gray-700 font-semibold">売上CSVをドラッグ＆ドロップ</p>
                            <p class="text-gray-500 text-sm mt-1">またはクリックして選択</p>
                            <input type="file" id="sales-file-input" class="hidden" accept=".csv" multiple>
                        </div>
                    </div>
                    <div id="sales-file-info" class="mt-2 text-center text-sm text-gray-600"></div>
                    <div class="mt-4 text-left bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="font-semibold text-gray-700 text-sm">売上CSVの形式</h3>
                        <ul class="list-disc list-inside text-sm text-gray-600 mt-2 space-y-1">
                            <li><strong>C列:</strong> 日時 (例: 2024/07/01 13:30)</li>
                            <li><strong>E列:</strong> カテゴリコード</li>
                            <li><strong>G列:</strong> 単価 (数字のみ)</li>
                        </ul>
                    </div>
                </div>
                <!-- 来店客数データアップロード -->
                <div id="visitor-upload-container">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">来店客数データ</h2>
                    <div id="visitor-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer bg-white hover:bg-gray-50 transition-colors">
                        <div class="flex flex-col items-center justify-center">
                             <svg class="w-12 h-12 text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962A3.375 3.375 0 0110.5 12h3c1.414 0 2.695.606 3.586 1.595M15.11 5.46A9.037 9.037 0 0112 3c-1.605 0-3.097.49-4.388 1.342M12 21a9.037 9.037 0 01-4.388-1.342" /></svg>
                            <p class="text-gray-700 font-semibold">来店客数CSVをドラッグ＆ドロップ</p>
                            <p class="text-gray-500 text-sm mt-1">またはクリックして選択</p>
                            <input type="file" id="visitor-file-input" class="hidden" accept=".csv" multiple>
                        </div>
                    </div>
                    <div id="visitor-file-info" class="mt-2 text-center text-sm text-gray-600"></div>
                     <div class="mt-4 text-left bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="font-semibold text-gray-700 text-sm">来店客数CSVの形式</h3>
                        <ul class="list-disc list-inside text-sm text-gray-600 mt-2 space-y-1">
                            <li><strong>C列:</strong> 集計年月日</li>
                            <li><strong>I列:</strong> 来店客数</li>
                        </ul>
                    </div>
                </div>
             </div>
             <div id="import-status" class="mt-6 p-4 rounded-lg bg-white shadow text-center font-semibold"></div>
        </div>

        <!-- Analytic ページ -->
        <div id="analytic-page" class="page hidden">
            <!-- サマリー -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200"><h3 class="text-gray-500 text-sm font-medium">総売上</h3><p id="total-revenue" class="text-2xl lg:text-3xl font-bold text-indigo-600 mt-1">¥0</p></div>
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200"><h3 class="text-gray-500 text-sm font-medium">販売点数</h3><p id="total-items" class="text-2xl lg:text-3xl font-bold text-indigo-600 mt-1">0</p></div>
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200"><h3 class="text-gray-500 text-sm font-medium">購買客数</h3><p id="customer-count" class="text-2xl lg:text-3xl font-bold text-indigo-600 mt-1">0</p></div>
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200"><h3 class="text-gray-500 text-sm font-medium">来店客数</h3><p id="visitor-count" class="text-2xl lg:text-3xl font-bold text-indigo-600 mt-1">0</p></div>
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200"><h3 class="text-gray-500 text-sm font-medium">購買転換率</h3><p id="conversion-rate" class="text-2xl lg:text-3xl font-bold text-indigo-600 mt-1">0%</p></div>
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200"><h3 class="text-gray-500 text-sm font-medium">平均顧客単価</h3><p id="avg-customer-spend" class="text-2xl lg:text-3xl font-bold text-indigo-600 mt-1">¥0</p></div>
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200"><h3 class="text-gray-500 text-sm font-medium">平均商品単価</h3><p id="average-price" class="text-2xl lg:text-3xl font-bold text-indigo-600 mt-1">¥0</p></div>
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200"><h3 class="text-gray-500 text-sm font-medium">平均購入点数</h3><p id="avg-items-per-customer" class="text-2xl lg:text-3xl font-bold text-indigo-600 mt-1">0</p></div>
            </div>

            <!-- タブナビゲーション -->
            <div class="mb-4 border-b border-gray-200 sticky top-16 bg-gray-100 z-10">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <a href="#" id="tab-daily" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">日次分析</a>
                    <a href="#" id="tab-weekly" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">週次分析</a>
                    <a href="#" id="tab-monthly" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">月次分析</a>
                </nav>
            </div>

            <!-- 日次分析タブ -->
            <div id="daily-tab-content" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="font-semibold text-lg mb-4">日別 売上</h3><div class="chart-container"><canvas id="daily-chart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="font-semibold text-lg mb-4">日別 購買客数</h3><div class="chart-container"><canvas id="daily-customer-count-chart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="font-semibold text-lg mb-4">日別 来店客数</h3><div class="chart-container"><canvas id="daily-visitor-count-chart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="font-semibold text-lg mb-4">日別 購買転換率</h3><div class="chart-container"><canvas id="daily-conversion-chart"></canvas></div></div>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="font-semibold text-lg mb-4">日別 カテゴリ購買数ランキング (TOP 3)</h3>
                    <div id="daily-category-rankings" class="space-y-6 overflow-y-auto max-h-96 custom-scrollbar pr-2"></div>
                </div>
            </div>

            <!-- 週次分析タブ -->
            <div id="weekly-tab-content" class="tab-content hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="font-semibold text-lg mb-4">週別 売上</h3><div class="chart-container"><canvas id="weekly-chart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="font-semibold text-lg mb-4">週別 購買客数・来店客数</h3><div class="chart-container"><canvas id="weekly-visitors-chart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="font-semibold text-lg mb-4">週別 購買転換率</h3><div class="chart-container"><canvas id="weekly-conversion-chart"></canvas></div></div>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mt-6">
                    <h3 class="font-semibold text-lg mb-4">週別 カテゴリ購買数ランキング (TOP 5)</h3>
                    <div id="weekly-category-rankings" class="space-y-6 overflow-y-auto max-h-96 custom-scrollbar pr-2"></div>
                </div>
            </div>

            <!-- 月次分析タブ -->
            <div id="monthly-tab-content" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="font-semibold text-lg mb-4">月別 売上</h3><div class="chart-container"><canvas id="monthly-chart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="font-semibold text-lg mb-4">月別 購買客数・来店客数</h3><div class="chart-container"><canvas id="monthly-visitors-chart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="font-semibold text-lg mb-4">月別 購買転換率</h3><div class="chart-container"><canvas id="monthly-conversion-chart"></canvas></div></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mt-6">
                    <h3 class="font-semibold text-lg mb-4">月別 カテゴリ購買数ランキング (TOP 5)</h3>
                    <div id="monthly-category-rankings" class="space-y-6 overflow-y-auto max-h-96 custom-scrollbar pr-2"></div>
                </div>
            </div>
        </div>

        <!-- Setting ページ -->
        <div id="setting-page" class="page hidden">
            <div class="bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto">
                <h1 class="text-2xl font-bold text-gray-900 mb-6">設定</h1>
                <div class="space-y-6">
                    <div>
                        <label for="store-name-input" class="block text-sm font-medium text-gray-700">店舗名</label>
                        <input type="text" id="store-name-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="address-input" class="block text-sm font-medium text-gray-700">住所</label>
                        <input type="text" id="address-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="tsubo-input" class="block text-sm font-medium text-gray-700">坪数</label>
                        <input type="number" id="tsubo-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="例: 15">
                    </div>
                    <div>
                        <label for="password-input" class="block text-sm font-medium text-gray-700">パスワード</label>
                        <div class="relative mt-1">
                            <input type="password" id="password-input" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm pr-10">
                            <div id="toggle-password-visibility" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer">
                                <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                 <svg id="eye-slash-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button id="save-settings-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            保存する
                        </button>
                    </div>
                    <p id="settings-success-message" class="text-green-600 text-sm text-center"></p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // DOM Elements
        const salesDropZone = document.getElementById('sales-drop-zone');
        const salesFileInput = document.getElementById('sales-file-input');
        const salesFileInfo = document.getElementById('sales-file-info');
        const visitorDropZone = document.getElementById('visitor-drop-zone');
        const visitorFileInput = document.getElementById('visitor-file-input');
        const visitorFileInfo = document.getElementById('visitor-file-info');
        const importStatus = document.getElementById('import-status');
        
        const storeNameDisplay = document.getElementById('display-store-name');
        const storeNameInput = document.getElementById('store-name-input');
        const addressInput = document.getElementById('address-input');
        const tsuboInput = document.getElementById('tsubo-input');
        const passwordInput = document.getElementById('password-input');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const settingsSuccessMessage = document.getElementById('settings-success-message');
        const togglePasswordVisibility = document.getElementById('toggle-password-visibility');
        const eyeIcon = document.getElementById('eye-icon');
        const eyeSlashIcon = document.getElementById('eye-slash-icon');

        let chartInstances = {};
        let salesData = [];
        let visitorData = [];
        let analysisResultCache = null;

        // --- カテゴリコードの変換マップ ---
        const oldTagMap = { '10': '半袖Ｔシャツ', '11': '長袖Ｔシャツ', '12': '半袖ポロシャツ', '13': '長袖ポロシャツ', '14': '半袖シャツ', '15': '長袖シャツ', '16': '半袖その他・ベスト', '17': '長袖その他', '30': 'パンツ', '31': 'ショートパンツ', '32': 'スカート', '40': 'トレーナー・パーカー・フリース', '41': 'カーディガン・ニット', '50': 'コート', '51': 'ジャケット・スーツ', '52': '革・ダウン・スタジャン', '53': 'アウターその他', '54': 'ナイロンジャケット', '60': 'オーバーオール・ワンピース', '61': 'ミリタリー・アウトドア', '62': 'スポーツウェア', 'FF': 'その他' };
        const newTagMap = { '0': 'Tシャツ', '1': 'シャツ/半袖', '2': 'シャツ/長袖', '3': 'ポロシャツ/半袖', '4': 'ポロシャツ/長袖', '5': 'ロングTシャツ', '6': 'ナイロン トラックジャケット', '7': 'ライトアウター', '8': 'ネルシャツ', '9': 'スウェット', 'A': 'パーカー', 'B': 'ハーフジップ', 'C': 'フリース', 'D': 'ヘビーアウター', 'E': 'パンツ', 'F': 'その他/小物' };
        
        function translateCategoryCode(code, dateTime) {
            if (!code) return 'カテゴリなし';
            const upperCode = code.toUpperCase();
            if (upperCode === 'F6D') return 'ワンピース';
            let useOldTagLogicOnly = false;
            if (dateTime) {
                const datePart = dateTime.split(' ')[0];
                const dateObj = new Date(datePart.replace(/[-.]/g, '/'));
                if (!isNaN(dateObj.getTime())) {
                    const oldTagStartDate = new Date('2024-09-01');
                    const oldTagEndDate = new Date('2025-05-01');
                    if (dateObj >= oldTagStartDate && dateObj < oldTagEndDate) {
                        useOldTagLogicOnly = true;
                    }
                }
            }
            let processedCode = upperCode;
            if (useOldTagLogicOnly) {
                const oldTagKey = processedCode.length >= 2 ? processedCode.substring(processedCode.length - 2) : null;
                if (oldTagMap[oldTagKey]) return oldTagMap[oldTagKey];
            } else {
                 if (processedCode.length === 2 && /^[0-9A-F]+$/.test(processedCode)) {
                     processedCode = '0' + processedCode;
                 }
                 const newTagKey = processedCode.substring(0, 1);
                 if (newTagMap[newTagKey]) return newTagMap[newTagKey];
                 const oldTagKey = processedCode.length >= 2 ? processedCode.substring(processedCode.length - 2) : null;
                 if (oldTagMap[oldTagKey]) return oldTagMap[oldTagKey];
            }
            return code;
        }

        // --- File Handling ---
        const createDropZone = (zone, input, info) => {
            zone.addEventListener('click', () => input.click());
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('border-indigo-500', 'bg-indigo-50'); });
            zone.addEventListener('dragleave', (e) => { e.preventDefault(); zone.classList.remove('border-indigo-500', 'bg-indigo-50'); });
            return (handler) => {
                zone.addEventListener('drop', (e) => { e.preventDefault(); zone.classList.remove('border-indigo-500', 'bg-indigo-50'); handler(e.dataTransfer.files, info); });
                input.addEventListener('change', (e) => { handler(e.target.files, info); });
            };
        };

        const handleFiles = async (files, infoElem, parser, dataArray) => {
            if (files.length === 0) return;
            infoElem.textContent = `${files.length}個のファイルを読み込み中...`;
            importStatus.textContent = '';
            importStatus.classList.remove('text-red-600', 'text-green-600');

            try {
                const fileReadPromises = Array.from(files).map(file => {
                    if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                        throw new Error('CSVファイルのみ選択してください。');
                    }
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = () => reject(new Error(`ファイルの読み込みに失敗: ${file.name}`));
                        reader.readAsText(file, 'Shift_JIS');
                    });
                });
                const csvTexts = await Promise.all(fileReadPromises);
                
                dataArray.length = 0;
                csvTexts.forEach(text => {
                    const parsed = parser(text);
                    dataArray.push(...parsed);
                });
                
                infoElem.textContent = `${files.length}個のファイルを処理しました。`;
                
                if (salesData.length > 0 || visitorData.length > 0) {
                    runAnalysisAndDisplay();
                } else {
                     importStatus.textContent = '有効なデータが読み込めませんでした。ファイルの形式を確認してください。';
                     importStatus.classList.add('text-red-600');
                }

            } catch(error) {
                infoElem.textContent = '';
                importStatus.textContent = error.message;
                importStatus.classList.add('text-red-600');
            }
        };

        createDropZone(salesDropZone, salesFileInput, salesFileInfo)(files => handleFiles(files, salesFileInfo, parseSalesCSV, salesData));
        createDropZone(visitorDropZone, visitorFileInput, visitorFileInfo)(files => handleFiles(files, visitorFileInfo, parseVisitorCSV, visitorData));

        function parseSalesCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            const data = [];
            console.log(`--- 売上CSV解析開始: ${lines.length - 1}行 ---`);
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length <= 6) {
                    console.warn(`Skipping sales row ${i + 1}: Not enough columns.`, values);
                    continue;
                }
                const dateTimeStr = values[2]?.trim();
                if (!dateTimeStr) {
                    console.warn(`Skipping sales row ${i + 1}: Date is empty.`, values);
                    continue;
                }
                const priceString = values[6] ? String(values[6]).replace(/[^0-9]/g, '') : '';
                const price = parseInt(priceString, 10);
                if (isNaN(price)) {
                    console.warn(`Skipping sales row ${i + 1}: Invalid price.`, values);
                    continue;
                }
                data.push({ dateTime: dateTimeStr, category: values[4]?.trim(), price: price });
            }
            console.log(`--- 売上CSV解析完了: ${data.length}件の有効データを取得 ---`);
            return data;
        }

        function parseVisitorCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            const data = [];
            console.log(`--- 来店客数CSV解析開始: ${lines.length - 1}行 ---`);
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                 if (values.length <= 8) {
                    console.warn(`Skipping visitor row ${i + 1}: Not enough columns.`, values);
                    continue;
                }
                const dateStr = values[2]?.trim();
                 if (!dateStr) {
                    console.warn(`Skipping visitor row ${i + 1}: Date is empty.`, values);
                    continue;
                }
                const visitorCount = parseInt(String(values[8]).replace(/[^0-9]/g, ''), 10);
                if (isNaN(visitorCount)) {
                    console.warn(`Skipping visitor row ${i + 1}: Invalid visitor count.`, values);
                    continue;
                }
                data.push({ date: dateStr, totalVisitors: visitorCount });
            }
            console.log(`--- 来店客数CSV解析完了: ${data.length}件の有効データを取得 ---`);
            return data;
        }

        function getFridayWeekStartDate(date) {
            const dayOfWeek = date.getDay();
            const offset = (dayOfWeek - 5 + 7) % 7;
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - offset);
            const year = weekStart.getFullYear();
            const month = (weekStart.getMonth() + 1).toString().padStart(2, '0');
            const day = weekStart.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // --- Analysis ---
        function analyzeData(sales, visitors) {
            const dailyData = {};
            const uniqueCustomers = new Set();

            // ★修正点：より堅牢な日付解析関数
            const parseDate = (dateString) => {
                if (!dateString) return null;
                const cleanDateString = dateString.trim().replace(/^"|"$/g, '');

                // YYYYMMDDHH or YYYYMMDD format
                if (/^\d{8}(\d{2})?$/.test(cleanDateString)) {
                    const year = parseInt(cleanDateString.substring(0, 4), 10);
                    const month = parseInt(cleanDateString.substring(4, 6), 10) - 1; // Month is 0-indexed
                    const day = parseInt(cleanDateString.substring(6, 8), 10);
                    const hours = cleanDateString.length >= 10 ? parseInt(cleanDateString.substring(8, 10), 10) : 0;
                    const dateObj = new Date(year, month, day, hours);
                    if (!isNaN(dateObj.getTime())) {
                        return dateObj;
                    }
                }

                // "YYYY-MM-DD HH:mm:ss" or "YYYY/MM/DD HH:mm:ss"
                const parts = cleanDateString.match(/(\d{4})[-.\/](\d{1,2})[-.\/](\d{1,2})(?:\s+(\d{1,2}):(\d{1,2}):(\d{1,2}))?/);
                if (parts) {
                    const year = parseInt(parts[1], 10);
                    const month = parseInt(parts[2], 10) - 1; // Month is 0-indexed
                    const day = parseInt(parts[3], 10);
                    const hours = parts[4] ? parseInt(parts[4], 10) : 0;
                    const minutes = parts[5] ? parseInt(parts[5], 10) : 0;
                    const seconds = parts[6] ? parseInt(parts[6], 10) : 0;
                    const dateObj = new Date(year, month, day, hours, minutes, seconds);
                     if (!isNaN(dateObj.getTime())) {
                        return dateObj;
                    }
                }

                return null; // Return null if no format matches
            };

            sales.forEach(item => {
                const dateObj = parseDate(item.dateTime);
                if (!dateObj || isNaN(dateObj.getTime())) {
                    console.error("Invalid date format found in sales data:", item.dateTime);
                    return;
                }
                const datePart = `${dateObj.getFullYear()}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${String(dateObj.getDate()).padStart(2, '0')}`;
                
                if (!dailyData[datePart]) {
                    dailyData[datePart] = { sales: 0, purchases: 0, visitors: 0, categoryCounts: {} };
                }
                
                const category = translateCategoryCode(item.category, item.dateTime);
                dailyData[datePart].sales += item.price;
                dailyData[datePart].purchases += 1;
                dailyData[datePart].categoryCounts[category] = (dailyData[datePart].categoryCounts[category] || 0) + 1;
                uniqueCustomers.add(item.dateTime);
            });

            visitors.forEach(item => {
                const dateObj = parseDate(item.date);
                if (!dateObj || isNaN(dateObj.getTime())) {
                    console.error("Invalid date format found in visitor data:", item.date);
                    return;
                }
                const datePart = `${dateObj.getFullYear()}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${String(dateObj.getDate()).padStart(2, '0')}`;
                if (!dailyData[datePart]) {
                    dailyData[datePart] = { sales: 0, purchases: 0, visitors: 0, categoryCounts: {} };
                }
                dailyData[datePart].visitors += item.totalVisitors;
            });

            const weeklyStats = {};
            const monthlyStats = {};

            for (const datePart in dailyData) {
                const dayData = dailyData[datePart];
                const dateObj = new Date(datePart);
                const weekStartDate = getFridayWeekStartDate(dateObj);
                const monthPart = `${dateObj.getFullYear()}/${String(dateObj.getMonth() + 1).padStart(2, '0')}`;

                if (!weeklyStats[weekStartDate]) weeklyStats[weekStartDate] = { sales: 0, purchases: 0, visitors: 0, categoryCounts: {} };
                if (!monthlyStats[monthPart]) monthlyStats[monthPart] = { sales: 0, purchases: 0, visitors: 0, categoryCounts: {} };

                weeklyStats[weekStartDate].sales += dayData.sales;
                weeklyStats[weekStartDate].purchases += dayData.purchases;
                weeklyStats[weekStartDate].visitors += dayData.visitors;
                for(const cat in dayData.categoryCounts) weeklyStats[weekStartDate].categoryCounts[cat] = (weeklyStats[weekStartDate].categoryCounts[cat] || 0) + dayData.categoryCounts[cat];

                monthlyStats[monthPart].sales += dayData.sales;
                monthlyStats[monthPart].purchases += dayData.purchases;
                monthlyStats[monthPart].visitors += dayData.visitors;
                for(const cat in dayData.categoryCounts) monthlyStats[monthPart].categoryCounts[cat] = (monthlyStats[monthPart].categoryCounts[cat] || 0) + dayData.categoryCounts[cat];
            }
            
            const calculateDerivedMetrics = (period) => {
                for (const key in period) {
                    const s = period[key];
                    s.customerCount = s.purchases;
                    s.conversionRate = s.visitors > 0 ? (s.customerCount / s.visitors) * 100 : 0;
                }
            };
            
            calculateDerivedMetrics(dailyData);
            calculateDerivedMetrics(weeklyStats);
            calculateDerivedMetrics(monthlyStats);
            
            const totalItems = sales.length;
            const customerCount = uniqueCustomers.size;
            const totalRevenue = sales.reduce((sum, item) => sum + item.price, 0);
            const totalVisitors = visitors.reduce((sum, item) => sum + item.totalVisitors, 0);

            return {
                totalRevenue, totalItems, customerCount,
                visitorCount: totalVisitors,
                conversionRate: totalVisitors > 0 ? (customerCount / totalVisitors) * 100 : 0,
                avgCustomerSpend: customerCount > 0 ? totalRevenue / customerCount : 0,
                averagePrice: totalItems > 0 ? totalRevenue / totalItems : 0,
                avgItemsPerCustomer: customerCount > 0 ? totalItems / customerCount : 0,
                daily: dailyData, weekly: weeklyStats, monthly: monthlyStats
            };
        }

        function runAnalysisAndDisplay() {
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};

            analysisResultCache = analyzeData(salesData, visitorData);
            
            importStatus.textContent = `売上データ${salesData.length}件、来店客データ${visitorData.length}件を読み込みました。`;
            importStatus.classList.add('text-green-600');

            displayDashboard(analysisResultCache);
            showPage('analytic-page');
            showTab('tab-daily');
        }

        function displayDashboard(result) {
            document.getElementById('total-revenue').textContent = `¥${result.totalRevenue.toLocaleString()}`;
            document.getElementById('total-items').textContent = result.totalItems.toLocaleString();
            document.getElementById('customer-count').textContent = result.customerCount.toLocaleString();
            document.getElementById('visitor-count').textContent = result.visitorCount.toLocaleString();
            document.getElementById('conversion-rate').textContent = `${result.conversionRate.toFixed(1)}%`;
            document.getElementById('avg-customer-spend').textContent = `¥${Math.round(result.avgCustomerSpend).toLocaleString()}`;
            document.getElementById('average-price').textContent = `¥${Math.round(result.averagePrice).toLocaleString()}`;
            document.getElementById('avg-items-per-customer').textContent = `${result.avgItemsPerCustomer.toFixed(1)} 点`;
            
            ['daily', 'weekly', 'monthly'].forEach(period => {
                const container = document.getElementById(`${period}-category-rankings`);
                container.innerHTML = '';
                const sortedKeys = Object.keys(result[period]).sort((a,b) => new Date(b) - new Date(a));
                if (sortedKeys.length === 0) {
                    container.innerHTML = `<div class="text-center text-gray-500 py-4">表示するデータがありません。</div>`;
                    return;
                }
                sortedKeys.forEach(key => {
                    const stats = result[period][key];
                    if(!stats.categoryCounts) return;
                    const ranked = Object.entries(stats.categoryCounts).sort(([,a],[,b]) => b-a).slice(0, period === 'daily' ? 3 : 5);
                    if(ranked.length === 0) return;
                    let displayKey = key;
                    if (period === 'weekly') {
                        const startDate = new Date(key.replace(/-/g, '/'));
                        const endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + 6);
                        displayKey = `${key.replace(/-/g, '/')} ～ ${(endDate.getMonth() + 1)}/${endDate.getDate()}`;
                    }
                    let html = `<div><h4 class="font-semibold text-md mb-2 bg-gray-50 p-2 rounded">${displayKey}</h4><div class="space-y-2 text-sm pl-2">`;
                    ranked.forEach(([name, value], index) => {
                        const percentage = stats.purchases > 0 ? ((value / stats.purchases) * 100).toFixed(1) : '0.0';
                        const rankColor = ['text-amber-500', 'text-slate-500', 'text-amber-700'][index] || 'text-gray-600';
                        html += `<div class="flex items-center"><span class="font-bold w-6 text-center ${rankColor}">${index + 1}.</span><div class="flex-1 font-semibold text-gray-800">${name}</div><div class="w-24 text-right text-gray-600">${value} 点 (${percentage}%)</div></div>`;
                    });
                    html += `</div></div>`;
                    container.innerHTML += html;
                });
            });
        }
        
        const createChart = (canvasId, options) => {
            const canvas = document.getElementById(canvasId);
            const container = canvas.parentElement;
            let noDataMessage = container.querySelector('.no-data-message');
            if (!noDataMessage) {
                noDataMessage = document.createElement('div');
                noDataMessage.className = 'no-data-message';
                noDataMessage.textContent = '表示するデータがありません。';
                container.appendChild(noDataMessage);
            }

            if (!options || !options.data || !options.data.labels || options.data.labels.length === 0) {
                canvas.style.display = 'none';
                noDataMessage.style.display = 'flex';
                if (chartInstances[canvasId]) {
                    chartInstances[canvasId].destroy();
                    delete chartInstances[canvasId];
                }
            } else {
                canvas.style.display = 'block';
                noDataMessage.style.display = 'none';
                if (chartInstances[canvasId]) {
                    chartInstances[canvasId].destroy();
                }
                chartInstances[canvasId] = new Chart(canvas.getContext('2d'), options);
            }
        };

        // --- UI Control ---
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');

        function showPage(pageId) {
            pages.forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            navLinks.forEach(link => link.classList.remove('active'));
            document.getElementById(`nav-${pageId.split('-')[0]}`).classList.add('active');
        }

        function showTab(tabId) {
            tabContents.forEach(content => content.classList.add('hidden'));
            const contentId = `${tabId.replace('tab-', '')}-tab-content`;
            const contentElement = document.getElementById(contentId);
            if (contentElement) contentElement.classList.remove('hidden');
            tabLinks.forEach(link => link.classList.remove('active'));
            const activeLink = document.getElementById(tabId);
            if(activeLink) activeLink.classList.add('active');
            
            requestAnimationFrame(() => {
                const result = analysisResultCache;
                if (!result) return;
                const colors = { sales: 'rgba(79, 70, 229, 0.8)', customers: 'rgba(5, 150, 105, 0.8)', visitors: 'rgba(249, 115, 22, 0.8)', conversion: 'rgba(239, 68, 68, 0.8)'};
                
                if (tabId === 'tab-daily') {
                    const sortedDays = Object.keys(result.daily).sort((a,b) => new Date(a) - new Date(b));
                    createChart('daily-chart', { type: 'bar', data: { labels: sortedDays, datasets: [{ label: '売上', data: sortedDays.map(d => result.daily[d].sales), backgroundColor: colors.sales }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                    createChart('daily-customer-count-chart', { type: 'bar', data: { labels: sortedDays, datasets: [{ label: '購買客数', data: sortedDays.map(d => result.daily[d].customerCount), backgroundColor: colors.customers }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                    createChart('daily-visitor-count-chart', { type: 'bar', data: { labels: sortedDays, datasets: [{ label: '来店客数', data: sortedDays.map(d => result.daily[d].visitors), backgroundColor: colors.visitors }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                    createChart('daily-conversion-chart', { type: 'line', data: { labels: sortedDays, datasets: [{ label: '転換率', data: sortedDays.map(d => result.daily[d].conversionRate.toFixed(1)), borderColor: colors.conversion, backgroundColor: colors.conversion, fill: false, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: v => `${v}%` } } } } });
                }

                if (tabId === 'tab-weekly') {
                    const sortedWeeks = Object.keys(result.weekly).sort((a,b) => new Date(a) - new Date(b));
                    createChart('weekly-chart', { type: 'bar', data: { labels: sortedWeeks, datasets: [{ label: '売上', data: sortedWeeks.map(w => result.weekly[w].sales), backgroundColor: colors.sales }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                    createChart('weekly-visitors-chart', { type: 'bar', data: { labels: sortedWeeks, datasets: [{ label: '購買客数', data: sortedWeeks.map(w => result.weekly[w].customerCount), backgroundColor: colors.customers }, { label: '来店客数', data: sortedWeeks.map(w => result.weekly[w].visitors), backgroundColor: colors.visitors }] }, options: { responsive: true, maintainAspectRatio: false } });
                    createChart('weekly-conversion-chart', { type: 'line', data: { labels: sortedWeeks, datasets: [{ label: '転換率', data: sortedWeeks.map(w => result.weekly[w].conversionRate.toFixed(1)), borderColor: colors.conversion, backgroundColor: colors.conversion, fill: false, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: v => `${v}%` } } } } });
                }

                if (tabId === 'tab-monthly') {
                    const sortedMonths = Object.keys(result.monthly).sort();
                    createChart('monthly-chart', { type: 'bar', data: { labels: sortedMonths, datasets: [{ label: '売上', data: sortedMonths.map(m => result.monthly[m].sales), backgroundColor: colors.sales }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                    createChart('monthly-visitors-chart', { type: 'bar', data: { labels: sortedMonths, datasets: [{ label: '購買客数', data: sortedMonths.map(m => result.monthly[m].customerCount), backgroundColor: colors.customers }, { label: '来店客数', data: sortedMonths.map(m => result.monthly[m].visitors), backgroundColor: colors.visitors }] }, options: { responsive: true, maintainAspectRatio: false } });
                    createChart('monthly-conversion-chart', { type: 'line', data: { labels: sortedMonths, datasets: [{ label: '転換率', data: sortedMonths.map(m => result.monthly[m].conversionRate.toFixed(1)), borderColor: colors.conversion, backgroundColor: colors.conversion, fill: false, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: v => `${v}%` } } } } });
                }
            }); 
        }
        
        function saveSettings() {
            const settings = {
                storeName: storeNameInput.value,
                address: addressInput.value,
                tsubo: tsuboInput.value,
                password: passwordInput.value
            };
            localStorage.setItem('dashboardSettings', JSON.stringify(settings));
            updateStoreName(settings.storeName);
            settingsSuccessMessage.textContent = '保存しました！';
            setTimeout(() => { settingsSuccessMessage.textContent = '' }, 3000);
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('dashboardSettings')) || {};
            updateStoreName(settings.storeName);
            storeNameInput.value = settings.storeName || '';
            addressInput.value = settings.address || '';
            tsuboInput.value = settings.tsubo || '';
            passwordInput.value = settings.password || '';
        }

        function updateStoreName(name) {
            storeNameDisplay.textContent = name || 'VINTAGE ANALYZER';
        }

        saveSettingsBtn.addEventListener('click', saveSettings);
        togglePasswordVisibility.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            eyeIcon.classList.toggle('hidden');
            eyeSlashIcon.classList.toggle('hidden');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showPage(`${e.target.id.split('-')[1]}-page`);
            });
        });

        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showTab(e.target.id);
            });
        });
        
        document.getElementById('go-to-import-btn').addEventListener('click', () => showPage('import-page'));

        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            showPage('home-page');
        });
    </script>
</body>
</html>
